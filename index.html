<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sterownik Wiatrowy ‚Äì MQTT</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    h1 { text-align:center; }
    .card { background:white; padding:15px; margin:10px auto; border-radius:10px; max-width:420px;
            box-shadow:0 2px 5px rgba(0,0,0,0.2); }
    .label { font-weight:bold; }
    .value { float:right; font-weight:700; }
    button { padding:10px 16px; margin-top:10px; border:none; border-radius:6px;
             background:#0d6efd; color:white; font-size:15px; cursor:pointer; }
    button.off { background:#dc3545; }
    .unit { margin-left:4px; color:#666; font-weight:500 }
    .windmill { width:120px; height:120px; margin:0 auto 15px; position:relative; }
    .rotor { width:100px; height:100px; position:absolute; top:10px; left:10px; transform-origin:50% 50%; animation:spin 4s linear infinite; }
    .blade { width:6px; height:40px; background:#0d6efd; position:absolute; left:47px; top:10px; border-radius:3px; transform-origin:50% 80%; }
    .blade:nth-child(2) { transform:rotate(120deg); }
    .blade:nth-child(3) { transform:rotate(240deg); }
    .hub { width:16px; height:16px; background:#333; border-radius:50%; position:absolute; top:42px; left:42px; }
    @keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
    #qrcode { text-align:center; margin-top:20px; }
  </style>
</head>
<body>
  <h1>üå¨Ô∏è Sterownik Wiatrowy</h1>

  <!-- Wiatrak -->
  <div class="windmill">
    <div class="rotor">
      <div class="blade"></div>
      <div class="blade"></div>
      <div class="blade"></div>
      <div class="hub"></div>
    </div>
  </div>

  <!-- Sensory -->
  <div class="card"><span class="label">Wiatrak (energia)</span> <span class="value"><span id="kwh">‚Äî</span><span class="unit">kWh</span></span></div>
  <div class="card"><span class="label">Moc ≈Çadowania</span> <span class="value"><span id="power">‚Äî</span><span class="unit">W</span></span></div>
  <div class="card"><span class="label">Na≈Çadowanie baterii</span> <span class="value"><span id="soc">‚Äî</span><span class="unit">%</span></span></div>
  <div class="card"><span class="label">Napiƒôcie baterii</span> <span class="value"><span id="bat_v">‚Äî</span><span class="unit">V</span></span></div>
  <div class="card"><span class="label">PrƒÖd ≈Çadowania</span> <span class="value"><span id="bat_a">‚Äî</span><span class="unit">A</span></span></div>

  <!-- Hamulec -->
  <div class="card">
    <span class="label">Hamulec turbiny</span>
    <span class="value" id="brake">‚Äî</span><br><br>
    <button id="btnBrake">Prze≈ÇƒÖcz hamulec</button>
  </div>

  <!-- Kod QR -->
  <div class="card" id="qrcode"></div>

  <script>
    // ---- USTAWIENIA ----
    const PREFIX = "sterownik_wiatrowy";                         
    const WS_URL = "wss://broker.hivemq.com:8884/mqtt";          

    // ---- PO≈ÅƒÑCZENIE ----
    const client = mqtt.connect(WS_URL, { clientId: "webdash_" + Math.random().toString(16).slice(2) });

    const els = {
      kwh:  document.getElementById("kwh"),
      power:document.getElementById("power"),
      soc:  document.getElementById("soc"),
      bat_v:document.getElementById("bat_v"),
      bat_a:document.getElementById("bat_a"),
      brake:document.getElementById("brake"),
      btn:  document.getElementById("btnBrake"),
    };

    let brakeState = "OFF";

    client.on("connect", () => {
      client.subscribe(`${PREFIX}/#`);
    });

    client.on("message", (topic, payload) => {
      const val = payload.toString();
      const parts = topic.split("/");
      const ix = parts.indexOf("sensor") >= 0 ? parts.indexOf("sensor") : parts.indexOf("switch");
      const key = (ix >= 0 && parts[ix+1]) ? parts[ix+1].toLowerCase() : "";

      if (key.includes("wiatrak") && key.includes("kwh")) { els.kwh.textContent = val; return; }
      if (key.startsWith("moc")) { els.power.textContent = val; return; }
      if (key.includes("procent") || key.includes("naladowania")) { els.soc.textContent = val; return; }
      if (key.startsWith("nap")) { els.bat_v.textContent = val; return; }
      if (key.startsWith("pr")) { els.bat_a.textContent = val; return; }

      if (key.includes("hamulec")) {
        brakeState = val;
        els.brake.textContent = (val === "ON") ? "W≈ÇƒÖczony" : "Wy≈ÇƒÖczony";
        els.btn.textContent = (val === "ON") ? "Wy≈ÇƒÖcz hamulec" : "W≈ÇƒÖcz hamulec";
        els.btn.className = (val === "ON") ? "off" : "";
        return;
      }
    });

    els.btn.addEventListener("click", () => {
      const next = (brakeState === "ON") ? "OFF" : "ON";
      client.publish(`${PREFIX}/switch/hamulec_turbiny/command`, next);
    });

    // ---- QR Code ----
    new QRCode(document.getElementById("qrcode"), {
      text: "https://tomasz179.github.io/Wiatrak-sterownik/",
      width: 200,
      height: 200
    });
  </script>
</body>
</html>
