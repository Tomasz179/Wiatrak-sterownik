<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sterownik Wiatrowy – Wind Speed (MQTT public)</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{ --card-w:1100px; }
    body { font-family: Arial, sans-serif; background:#f6f7fb; padding:20px; color:#111; }
    h1 { text-align:center; margin:8px 0 14px; }

    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
      gap:12px;
      max-width:var(--card-w);
      margin:0 auto;
    }
    .card {
      background:white;
      padding:15px;
      border-radius:12px;
      box-shadow:0 3px 10px rgba(0,0,0,0.07);
    }
    .label { font-weight:bold; }
    .value { float:right; font-weight:700; }
    .unit { margin-left:4px; color:#666; font-weight:500 }

    /* Wiatrak */
    .wind-wrap{max-width:var(--card-w); margin:0 auto;}
    .wind-svg { display:block; margin:0 auto 6px; width:240px; height:auto; }
    .blades {
      transform-origin: 32px 24px;
      animation: spin var(--dur, 4s) linear infinite;
      animation-play-state: var(--play, running);
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    /* Pasek statusu */
    #status { max-width:var(--card-w); margin:0.5rem auto; font-size:12px; color:#333; }
    #status b { font-weight:700; }

    /* QR */
    #qrcode { margin:18px auto; width:fit-content; }
    .small { font-size: 12px; color:#666; margin-top:6px; }
  </style>
</head>

<body>
  <div id="app">
    <div class="wind-wrap">
      <svg class="wind-svg" viewBox="0 0 64 64" aria-label="wiatrak">
        <path d="M32 28 L28 62 L36 62 Z" fill="#2c3e50"/>
        <rect x="18" y="62" width="28" height="2" rx="1" fill="#7f8c8d"/>
        <circle cx="32" cy="24" r="4.2" fill="#2c3e50"/>
        <g class="blades" id="blades">
          <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9"/>
          <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(120 32 24)"/>
          <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(240 32 24)"/>
        </g>
      </svg>
    </div>

    <h1>Sterownik Wiatrowy – publiczny odczyt</h1>
    <div id="status">Status MQTT: <b id="mqttStatus">inicjalizacja…</b></div>

    <div class="grid">
      <div class="card">
        <span class="label">Prędkość wiatru</span>
        <span class="value"><span id="wind">—</span><span class="unit">m/s</span></span>
        <div class="small">Topic: <code>sterownik_wiatrowy/public/wind_speed</code></div>
      </div>

      <div class="card">
        <span class="label">Ostatnia aktualizacja</span>
        <span class="value" id="ts">—</span>
        <div class="small">Wartość pochodzi z publicznego MQTT (HiveMQ).</div>
      </div>
    </div>

    <div id="qrcode"></div>
  </div>

<script>
(function initApp(){
  // ====== USTAWIENIA ======
  const PREFIX = "sterownik_wiatrowy";
  const TOPIC_WIND = `${PREFIX}/public/wind_speed`;

  // HiveMQ public WebSocket Secure
  const WS_URL = "wss://broker.hivemq.com:8884/mqtt";

  // ====== HELPERY ======
  function parseNumber(val){
    const m = String(val).match(/-?\d+(?:[.,]\d+)?/);
    return m ? parseFloat(m[0].replace(',', '.')) : NaN;
  }
  function fmt1dec(n){
    if (isNaN(n)) return "—";
    return (Math.round(n*10)/10).toFixed(1).replace('.', ',');
  }
  function nowTime(){
    const d = new Date();
    return d.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  // ====== UI ======
  const els = {
    wind: document.getElementById('wind'),
    ts: document.getElementById('ts'),
    mqttStatus: document.getElementById('mqttStatus'),
  };
  const blades = document.getElementById('blades');

  let lastWind = null;

  function recomputeRotor(){
    // Prosta mapa: 0..25 m/s => szybciej
    let dur = 4.0;
    if (lastWind != null && !isNaN(lastWind)) {
      const w = Math.max(0, Math.min(25, lastWind));
      const rpm = 10 + w * 8;        // 10..210 rpm
      dur = Math.max(0.6, 60 / rpm); // im większe rpm, tym mniejszy czas obrotu
    } else {
      dur = 4.0;
    }
    blades.style.setProperty('--dur', dur.toFixed(2) + 's');
    blades.style.setProperty('--play', 'running');
  }

  // ====== MQTT ======
  const client = mqtt.connect(WS_URL, {
    clientId: 'webdash_' + Math.random().toString(16).slice(2),
    clean: true,
    connectTimeout: 8000,
    reconnectPeriod: 2000
  });

  client.on('connect', () => {
    els.mqttStatus.textContent = 'połączono';
    client.subscribe(TOPIC_WIND, { qos: 0 }, (err) => {
      if (err) console.error('SUB error:', err);
      else console.log('SUB:', TOPIC_WIND);
    });
  });

  client.on('reconnect', () => { els.mqttStatus.textContent = 'ponowne łączenie…'; });
  client.on('close', () => { els.mqttStatus.textContent = 'rozłączono'; });
  client.on('error', (e) => {
    els.mqttStatus.textContent = 'błąd MQTT (konsola)';
    console.error('MQTT error:', e);
  });

  client.on('message', (topic, payload) => {
    const val = payload.toString();
    console.log('MQTT:', topic, '=>', val);

    if (topic === TOPIC_WIND) {
      const v = parseNumber(val);
      if (isNaN(v)) {
        lastWind = null;
        els.wind.textContent = "—";
      } else {
        lastWind = v;
        els.wind.textContent = fmt1dec(v);
      }
      els.ts.textContent = nowTime();
      recomputeRotor();
    }
  });

  // ====== QR ======
  new QRCode(document.getElementById('qrcode'), {
    text: window.location.href,
    width: 200,
    height: 200
  });

  recomputeRotor();
})();
</script>
</body>
</html>
