<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sterownik Wiatrowy – MQTT</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    :root{ --card-w:1100px; }

    /* ===== TŁO: NIEBO + SŁOŃCE + CHMURY + ŁĄKA ===== */
    body{
      font-family: Arial, sans-serif;
      padding:20px;
      color:#111;
      min-height:100vh;
      background:
        /* chmury */
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.9) 0%, transparent 40%),
        radial-gradient(circle at 45% 18%, rgba(255,255,255,0.8) 0%, transparent 45%),
        radial-gradient(circle at 70% 22%, rgba(255,255,255,0.85) 0%, transparent 42%),

        /* słońce */
        radial-gradient(circle at 85% 12%, #fff59d 0%, #ffe082 8%, rgba(255,224,130,0.4) 14%, transparent 22%),

        /* niebo */
        linear-gradient(
          to bottom,
          #8fd3f4 0%,
          #b3e5fc 35%,
          #e1f5fe 55%,
          #7ec850 56%,
          #4caf50 100%
        );
      background-attachment: fixed;
    }

    h1 { text-align:center; margin:8px 0 14px; }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
      max-width:var(--card-w);
      margin:0 auto;
    }

    .card{
      background:rgba(255,255,255,0.95);
      padding:15px;
      border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
      backdrop-filter: blur(2px);
    }

    .label{font-weight:bold;}
    .value{float:right;font-weight:700;}
    .unit{margin-left:4px;color:#666;font-weight:500;}

    /* Wiatrak */
    .wind-wrap{max-width:var(--card-w);margin:0 auto;}
    .wind-svg{display:block;margin:0 auto 6px;width:240px;height:auto;}
    .blades{
      transform-origin:32px 24px;
      animation:spin var(--dur,4s) linear infinite;
      animation-play-state:var(--play,running);
    }
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    /* Status */
    #status{
      max-width:var(--card-w);
      margin:0.5rem auto 1rem;
      font-size:12px;
      text-align:center;
    }
    #status b{font-weight:700;}
  </style>
</head>

<body>
<div id="app">

  <div class="wind-wrap">
    <svg class="wind-svg" viewBox="0 0 64 64">
      <path d="M32 28 L28 62 L36 62 Z" fill="#2c3e50"/>
      <rect x="18" y="62" width="28" height="2" rx="1" fill="#7f8c8d"/>
      <circle cx="32" cy="24" r="4.2" fill="#2c3e50"/>
      <g class="blades" id="blades">
        <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9"/>
        <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(120 32 24)"/>
        <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(240 32 24)"/>
      </g>
    </svg>
  </div>

  <h1>Sterownik Wiatrowy M6</h1>
  <div id="status">Status MQTT: <b id="mqttStatus">inicjalizacja…</b></div>

  <div class="grid">
    <div class="card"><span class="label">Wiatrak (energia)</span><span class="value"><span id="kwh">—</span><span class="unit">kWh</span></span></div>
    <div class="card"><span class="label">Moc ładowania</span><span class="value"><span id="power">—</span><span class="unit">W</span></span></div>
    <div class="card"><span class="label">Naładowanie baterii</span><span class="value"><span id="soc">—</span><span class="unit">%</span></span></div>
    <div class="card"><span class="label">Napięcie baterii</span><span class="value"><span id="bat_v">—</span><span class="unit">V</span></span></div>
    <div class="card"><span class="label">Prąd ładowania</span><span class="value"><span id="bat_a">—</span><span class="unit">A</span></span></div>
    <div class="card"><span class="label">Prędkość wiatru</span><span class="value"><span id="wind">—</span><span class="unit">m/s</span></span></div>
    <div class="card"><span class="label">Hamulec turbiny</span><span class="value" id="brake">—</span></div>
    <div class="card"><span class="label">Wyjście LOAD</span><span class="value" id="loadState">—</span></div>
  </div>

</div>

<script>
function initApp(){
  const PREFIX="sterownik_wiatrowy";
  const WS_URL="wss://broker.hivemq.com:8884/mqtt";
  const TOPIC_WIND_PUBLIC=`${PREFIX}/public/wind_speed`;

  const els={
    kwh:kwh,power:power,soc:soc,bat_v:bat_v,bat_a:bat_a,
    wind:wind,brake:brake,loadState:loadState,mqttStatus:mqttStatus
  };

  const blades=document.getElementById('blades');
  let brakeState='OFF',lastWind=null,lastPower=null;

  const fmt=n=>isNaN(n)?"—":(Math.round(n*10)/10).toFixed(1).replace('.',',');

  function rotor(){
    let d=lastWind!=null?Math.max(0.6,60/(10+lastWind*8)):4;
    blades.style.setProperty('--dur',d+'s');
    blades.style.setProperty('--play',brakeState==='ON'?'paused':'running');
  }

  const client=mqtt.connect(WS_URL,{clientId:'web_'+Math.random().toString(16).slice(2)});
  client.on('connect',()=>{mqttStatus.textContent='połączono';client.subscribe(TOPIC_WIND_PUBLIC);});
  client.on('message',(t,p)=>{
    if(t===TOPIC_WIND_PUBLIC){
      lastWind=parseFloat(p)||null;
      wind.textContent=fmt(lastWind);
      rotor();
    }
  });
}
document.addEventListener('DOMContentLoaded',initApp);
</script>
</body>
</html>
