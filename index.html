<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sterownik Wiatrowy – Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body{ font-family: Arial,sans-serif; padding:20px; background:#000; color:#fff; }
.grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; max-width:1100px; margin:0 auto; }
.card{ background: rgba(255,255,255,0.9); padding:15px; border-radius:12px; color:#111; }
.label{ font-weight:bold; } .value{ float:right; font-weight:700; min-width:60px; text-align:right; display:inline-block; } .unit{ margin-left:4px; color:#666; font-weight:500; }
.wind-card.good{background: #e8f5e9;} .wind-card.mid{background: #fff9c4;} .wind-card.high{background: #ffe0b2;} .wind-card.danger{background: #ffcdd2;}
</style>
</head>
<body>
<h1>Sterownik Wiatrowy</h1>
<div id="status">MQTT: <b id="mqttStatus">—</b> <span id="diag"></span></div>
<div class="grid">
  <div class="card"><span class="label">Napięcie baterii</span><span class="value"><span id="bat_v">—</span><span class="unit">V</span></span></div>
  <div class="card"><span class="label">Napięcie wiatrak</span><span class="value"><span id="fan_v">—</span><span class="unit">V</span></span></div>
  <div class="card"><span class="label">Prąd wiatrak</span><span class="value"><span id="fan_a">—</span><span class="unit">A</span></span></div>
  <div class="card"><span class="label">Moc wiatrak</span><span class="value"><span id="fan_p">—</span><span class="unit">W</span></span></div>
  <div class="card"><span class="label">Energia wiatraka</span><span class="value"><span id="fan_kwh">—</span><span class="unit">kWh</span></span></div>
  <div class="card wind-card" id="windCard"><span class="label">Prędkość wiatru</span><span class="value"><span id="wind">—</span><span class="unit">m/s</span></span></div>
</div>

<script>
(() => {
  const PREFIX="sterownik_wiatrowy/sterownik-wiatrak";
  const WS_URL="wss://broker.hivemq.com:8884/mqtt";
  const TOPIC_WIND=`${PREFIX}/public/wind_speed`;
  const MID=3,HIGH=8,DANG=15;

  const els={
    bat_v: document.getElementById('bat_v'),
    fan_v: document.getElementById('fan_v'),
    fan_a: document.getElementById('fan_a'),
    fan_p: document.getElementById('fan_p'),
    fan_kwh: document.getElementById('fan_kwh'),
    wind: document.getElementById('wind'),
    windCard: document.getElementById('windCard'),
    mqttStatus: document.getElementById('mqttStatus'),
    diag: document.getElementById('diag')
  };

  function fmt(v){ return isNaN(v)?"—":v.toFixed(1).replace('.',','); }
  function windColor(w){ 
    els.windCard.className="card wind-card";
    if(isNaN(w)) return;
    if(w<MID) els.windCard.classList.add('good');
    else if(w<HIGH) els.windCard.classList.add('mid');
    else if(w<DANG) els.windCard.classList.add('high');
    else els.windCard.classList.add('danger');
  }

  let msgCount=0,lastMsg=0;
  const diag=()=> els.diag.innerHTML=` | msg: <b>${msgCount}</b> | ostatnio: <b>${lastMsg?new Date(lastMsg).toLocaleTimeString():"—"}</b>`;

  const client=mqtt.connect(WS_URL,{clientId:"web_"+Math.random().toString(16).slice(2)});
  client.on('connect',()=>{ els.mqttStatus.textContent="połączono"; client.subscribe(`${PREFIX}/sensor/#`); client.subscribe(TOPIC_WIND); });
  client.on('offline',()=>els.mqttStatus.textContent="offline");
  client.on('error',()=>els.mqttStatus.textContent="błąd MQTT");

  client.on('message',(topic,payload)=>{
    msgCount++; lastMsg=Date.now(); diag();
    const val=parseFloat(payload.toString());
    if(topic.endsWith("napiecie_baterii/state")) els.bat_v.textContent = fmt(val);
    else if(topic.endsWith("napiecie_wiatrak/state")) els.fan_v.textContent = fmt(val);
    else if(topic.endsWith("prad_wiatrak/state")) els.fan_a.textContent = fmt(val);
    else if(topic.endsWith("moc_wiatrak/state")) els.fan_p.textContent = fmt(val);
    else if(topic.endsWith("wiatrak_kwh/state")) els.fan_kwh.textContent = fmt(val);
    else if(topic===TOPIC_WIND){ els.wind.textContent = fmt(val); windColor(val); }
  });
})();
</script>
</body>
</html>
