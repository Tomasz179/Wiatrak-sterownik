<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sterownik Wiatrowy – MQTT</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    :root{
      --card-w:1100px;

      /* ====== DOPASOWANIE ŁOPAT DO TAPETY (łatwe do korekty) ======
         Jeśli łopaty nie trafią idealnie w środek wirnika na zdjęciu,
         ruszasz tylko te 3 wartości:
      */
      --rotor-left: 73.6vw;   /* pozycja X środka wirnika */
      --rotor-top:  22.0vh;   /* pozycja Y środka wirnika */
      --rotor-size: 38vmin;   /* rozmiar łopat (skala) */
    }

    body{
      font-family: Arial, sans-serif;
      padding:20px;
      color:#111;
      min-height:100vh;
      margin:0;

      /* TAPETA (wyraźna) */
      background-image: url("assets/wiatrak.png");
      background-size: cover;
      background-position: center top;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    /* Mobile: lepsza płynność przewijania */
    @media (max-width: 768px){
      body{ background-attachment: scroll; }
    }

    /* Warstwa tła z animacją łopat (ZA kartami, NAD tapetą) */
    .bg-stage{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    /* Delikatny overlay pod kartami (nie rozmywa tapety, tylko pomaga czytelności) */
    .ui-overlay{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      background: linear-gradient(
        to bottom,
        rgba(255,255,255,0.00) 0%,
        rgba(255,255,255,0.08) 35%,
        rgba(255,255,255,0.18) 100%
      );
    }

    /* UI */
    #app{ position: relative; z-index: 2; }

    h1 { text-align:center; margin:8px 0 14px; }

    #status {
      max-width:var(--card-w);
      margin:0.5rem auto 1rem;
      font-size:12px;
      text-align:center;
      color:#111;
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
    }
    #status b { font-weight:700; }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
      gap:12px;
      max-width:var(--card-w);
      margin:0 auto;
    }

    .card{
      background: rgba(255,255,255,0.92);
      padding:15px;
      border-radius:14px;
      box-shadow:0 10px 22px rgba(0,0,0,0.14);
      backdrop-filter: blur(2px);
    }

    .label{ font-weight:bold; }
    .value{ float:right; font-weight:700; }
    .unit{ margin-left:4px; color:#666; font-weight:500 }

    /* Karta wiatru: kolorowana */
    .wind-card { border: 1px solid rgba(0,0,0,0.06); }
    .wind-card.good   { background: rgba(232,245,233,0.92); }
    .wind-card.mid    { background: rgba(255,249,196,0.92); }
    .wind-card.high   { background: rgba(255,224,178,0.92); }
    .wind-card.danger { background: rgba(255,205,210,0.92); }

    /* ====== ANIMOWANE ŁOPATY NA TAPECIE ====== */
    .rotor-wrap{
      position: absolute;
      left: var(--rotor-left);
      top:  var(--rotor-top);
      width: var(--rotor-size);
      height: var(--rotor-size);
      transform: translate(-50%, -50%);
      transform-origin: center;
      filter: drop-shadow(0 10px 10px rgba(0,0,0,0.35));
      opacity: 0.85;
    }

    /* obrót */
    .rotor{
      width:100%;
      height:100%;
      transform-origin: 50% 50%;
      animation: spin var(--dur, 4s) linear infinite;
      animation-play-state: var(--play, running);
    }

    @keyframes spin{
      from{ transform: rotate(0deg); }
      to  { transform: rotate(360deg); }
    }

    /* delikatne „rozmycie ruchu” przy szybszym obrocie */
    .rotor.fast { filter: blur(0.2px); }
    .rotor.veryfast { filter: blur(0.35px); }
  </style>
</head>

<body>
  <!-- TŁO: animowane łopaty -->
  <div class="bg-stage" aria-hidden="true">
    <div class="rotor-wrap">
      <!-- SAME ŁOPATY (bez masztu), żeby "wtopić" w zdjęcie -->
      <svg class="rotor" id="bgRotor" viewBox="0 0 200 200">
        <!-- piasta -->
        <circle cx="100" cy="100" r="10" fill="rgba(230,230,230,0.95)"/>
        <circle cx="100" cy="100" r="5" fill="rgba(180,180,180,0.95)"/>

        <!-- łopaty (3 szt.) -->
        <g fill="rgba(245,245,245,0.95)">
          <!-- łopata 1 -->
          <path d="M100 100
                   C115 90, 155 78, 185 72
                   C191 71, 194 75, 190 79
                   C165 103, 135 120, 112 116
                   C103 114, 99 108, 100 100Z"/>
          <!-- łopata 2 -->
          <path d="M100 100
                   C98 118, 90 160, 76 188
                   C73 194, 67 192, 67 186
                   C67 156, 78 124, 92 108
                   C98 102, 104 103, 100 100Z"
                transform="rotate(120 100 100)"/>
          <!-- łopata 3 -->
          <path d="M100 100
                   C115 90, 155 78, 185 72
                   C191 71, 194 75, 190 79
                   C165 103, 135 120, 112 116
                   C103 114, 99 108, 100 100Z"
                transform="rotate(240 100 100)"/>
        </g>
      </svg>
    </div>
  </div>

  <!-- Delikatny overlay pod UI -->
  <div class="ui-overlay" aria-hidden="true"></div>

  <!-- UI -->
  <div id="app">
    <h1>Sterownik Wiatrowy M6</h1>
    <div id="status">Status MQTT: <b id="mqttStatus">inicjalizacja…</b></div>

    <div class="grid">
      <div class="card">
        <span class="label">Wiatrak (energia)</span>
        <span class="value"><span id="kwh">—</span><span class="unit">kWh</span></span>
      </div>

      <div class="card">
        <span class="label">Moc ładowania</span>
        <span class="value"><span id="power">—</span><span class="unit">W</span></span>
      </div>

      <div class="card">
        <span class="label">Naładowanie baterii</span>
        <span class="value"><span id="soc">—</span><span class="unit">%</span></span>
      </div>

      <div class="card">
        <span class="label">Napięcie baterii</span>
        <span class="value"><span id="bat_v">—</span><span class="unit">V</span></span>
      </div>

      <div class="card">
        <span class="label">Prąd ładowania</span>
        <span class="value"><span id="bat_a">—</span><span class="unit">A</span></span>
      </div>

      <div class="card wind-card" id="windCard">
        <span class="label">Prędkość wiatru</span>
        <span class="value"><span id="wind">—</span><span class="unit">m/s</span></span>
      </div>

      <div class="card">
        <span class="label">Hamulec turbiny</span>
        <span class="value" id="brake">—</span>
      </div>

      <div class="card">
        <span class="label">Wyjście LOAD</span>
        <span class="value" id="loadState">—</span>
      </div>
    </div>
  </div>

<script>
function initApp(){
  const PREFIX = "sterownik_wiatrowy";
  const WS_URL = "wss://broker.hivemq.com:8884/mqtt";
  const TOPIC_WIND_PUBLIC = `${PREFIX}/public/wind_speed`;

  // progi (m/s) – do kolorowania i animacji
  const STOP_AT = 0.2;
  const MID_AT  = 3.0;
  const HIGH_AT = 8.0;
  const DANG_AT = 15.0;

  function parseNumber(val){
    const m = String(val).match(/-?\d+(?:[.,]\d+)?/);
    return m ? parseFloat(m[0].replace(',', '.')) : NaN;
  }
  function fmt1dec(n){
    if(isNaN(n)) return "—";
    return (Math.round(n*10)/10).toFixed(1).replace('.',',');
  }

  const els = {
    kwh:  document.getElementById('kwh'),
    power:document.getElementById('power'),
    soc:  document.getElementById('soc'),
    bat_v:document.getElementById('bat_v'),
    bat_a:document.getElementById('bat_a'),
    wind: document.getElementById('wind'),
    windCard: document.getElementById('windCard'),
    brake:document.getElementById('brake'),
    loadState:document.getElementById('loadState'),
    mqttStatus:document.getElementById('mqttStatus'),
    rotor: document.getElementById('bgRotor'),
  };

  let brakeState = 'OFF';
  let lastWind = null;
  let lastPower = null;

  function setWindCardClass(w){
    els.windCard.classList.remove('good','mid','high','danger');
    if(w == null || isNaN(w)) return;
    if(w < MID_AT) els.windCard.classList.add('good');
    else if(w < HIGH_AT) els.windCard.classList.add('mid');
    else if(w < DANG_AT) els.windCard.classList.add('high');
    else els.windCard.classList.add('danger');
  }

  function setRotorSpeedFromWind(w){
    // hamulec albo brak wiatru -> stop
    if (brakeState === 'ON' || w == null || isNaN(w) || w < STOP_AT) {
      els.rotor.style.setProperty('--play', 'paused');
      els.rotor.classList.remove('fast','veryfast');
      return;
    }

    // mapowanie wiatru na czas obrotu (dur)
    const ww = Math.max(0, Math.min(25, w)); // 0..25 m/s
    const rpm = 6 + ww * 6.5;               // dopasowane "pod oko"
    const dur = Math.max(0.55, 60 / rpm);   // sekundy na obrót

    els.rotor.style.setProperty('--dur', dur.toFixed(2) + 's');
    els.rotor.style.setProperty('--play', 'running');

    // lekkie rozmycie przy dużych obrotach
    els.rotor.classList.toggle('fast', ww >= 10);
    els.rotor.classList.toggle('veryfast', ww >= 16);
  }

  const TOPICS = {
    kwh:   [`${PREFIX}/sensor/wiatrak_kwh/state`],
    power: [`${PREFIX}/sensor/moc__adowania/state`, `${PREFIX}/sensor/moc___adowania/state`],
    soc:   [`${PREFIX}/sensor/procent_na__adowania_baterii/state`, `${PREFIX}/sensor/procent_na_adowania_baterii/state`],
    bat_v: [`${PREFIX}/sensor/napi_cie_baterii/state`, `${PREFIX}/sensor/napi__cie_baterii/state`],
    bat_a: [`${PREFIX}/sensor/pr_d__adowania/state`, `${PREFIX}/sensor/pr__d___adowania/state`],
    brake_state: [`${PREFIX}/switch/hamulec_turbiny/state`],
    load_state:  [`${PREFIX}/switch/wyjscie_load/state`, `${PREFIX}/switch/wyj__cie_load/state`],
  };

  const matchTopic = (incoming, candidates) =>
    (Array.isArray(candidates)?candidates:[candidates]).includes(incoming);

  const noteNum = (val) => {
    const v = parseNumber(val);
    return isNaN(v) ? null : v;
  };

  const client = mqtt.connect(WS_URL, {
    clientId: 'webdash_'+Math.random().toString(16).slice(2),
    clean: true,
    connectTimeout: 8000,
    reconnectPeriod: 2000,
  });

  client.on('connect', ()=>{
    els.mqttStatus.textContent = 'połączono';
    Object.values(TOPICS).flat().forEach(t=>client.subscribe(t, {qos:0}));
    client.subscribe(TOPIC_WIND_PUBLIC, {qos:0});
  });

  client.on('reconnect', ()=>{ els.mqttStatus.textContent='ponowne łączenie…'; });
  client.on('close', ()=>{ els.mqttStatus.textContent='rozłączono'; });
  client.on('error',(e)=>{ els.mqttStatus.textContent='błąd MQTT (konsola)'; console.error('MQTT error:', e); });

  client.on('message',(topic,payload)=>{
    const val = payload.toString();

    if (topic === TOPIC_WIND_PUBLIC) {
      const v = noteNum(val);
      lastWind = v;
      els.wind.textContent = (v == null) ? "—" : fmt1dec(v);
      setWindCardClass(v);
      setRotorSpeedFromWind(v);
      return;
    }

    if (matchTopic(topic, TOPICS.kwh)) {
      const v = noteNum(val);
      els.kwh.textContent = (v == null) ? "—" : fmt1dec(v);
      return;
    }

    if (matchTopic(topic, TOPICS.power)) {
      const v = noteNum(val);
      lastPower = v;
      els.power.textContent = (v == null) ? "—" : fmt1dec(v);
      return;
    }

    if (matchTopic(topic, TOPICS.soc)) {
      const v = noteNum(val);
      els.soc.textContent = (v == null) ? "—" : fmt1dec(v);
      return;
    }

    if (matchTopic(topic, TOPICS.bat_v)) {
      const v = noteNum(val);
      els.bat_v.textContent = (v == null) ? "—" : fmt1dec(v);
      return;
    }

    if (matchTopic(topic, TOPICS.bat_a)) {
      const v = noteNum(val);
      els.bat_a.textContent = (v == null) ? "—" : fmt1dec(v);
      return;
    }

    if (matchTopic(topic, TOPICS.brake_state)) {
      const s = String(val).trim().toUpperCase();
      brakeState = s;
      els.brake.textContent = (s==='ON') ? 'Włączony' : 'Wyłączony';
      setRotorSpeedFromWind(lastWind);
      return;
    }

    if (matchTopic(topic, TOPICS.load_state)) {
      const s = String(val).trim().toUpperCase();
      els.loadState.textContent = (s==='ON') ? 'Włączone' : 'Wyłączone';
      return;
    }
  });

  // start
  setWindCardClass(null);
  setRotorSpeedFromWind(null);
}

document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
