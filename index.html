<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sterownik Wiatrowy ‚Äì MQTT</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }

    /* BLOKADA HAS≈ÅA */
    #lock { position:fixed; inset:0; background:#0b0f1a; display:flex; align-items:center; justify-content:center; z-index:9999; }
    #lock .box { background:#fff; padding:20px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); width:320px; text-align:center; }
    #lock h3 { margin:0 0 10px; }
    #lock input { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; }
    #lock button { width:100%; padding:10px; border:none; border-radius:8px; background:#0d6efd; color:#fff; font-size:15px; cursor:pointer; }
    #lock p { color:#c00; min-height:1em; font-size:13px; }

    h1 { text-align:center; margin:8px 0 14px; }
    .card { background:white; padding:15px; margin:10px auto; border-radius:10px; max-width:420px; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
    .label { font-weight:bold; }
    .value { float:right; font-weight:700; }
    .unit { margin-left:4px; color:#666; font-weight:500 }
    button { padding:10px 16px; margin-top:10px; border:none; border-radius:6px; background:#0d6efd; color:white; font-size:15px; cursor:pointer; }
    button.off { background:#dc3545; }

    /* Wiatrak */
    .wind-svg { display:block; margin:0 auto 6px; width:240px; height:auto; }
    .blades { transform-origin: 32px 24px; animation: spin var(--dur, 4s) linear infinite; animation-play-state: var(--play, running); }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }

    /* Wykres */
    .chart-card { padding:15px; background:#fff; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.2); margin-top:14px; max-width:900px; margin-left:auto; margin-right:auto; }
    .chart-toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .chart-toolbar input[type="date"] { padding:6px 8px; border:1px solid #ddd; border-radius:8px; }
    .muted { color:#666; font-size:13px; }
    #qrcode { margin:26px auto; width:fit-content; }
  </style>
</head>
<body>
  <!-- HAS≈ÅO -->
  <div id="lock">
    <div class="box">
      <h3>üîê Dostƒôp chroniony</h3>
      <input id="pwd" type="password" placeholder="Has≈Ço" autocomplete="current-password" />
      <button id="unlockBtn">Odblokuj</button>
      <p id="lockMsg"></p>
    </div>
  </div>

  <!-- APLIKACJA -->
  <div id="app" style="display:none;">

    <!-- Wiatrak -->
    <svg class="wind-svg" viewBox="0 0 64 64">
      <path d="M32 28 L28 62 L36 62 Z" fill="#2c3e50"/>
      <rect x="18" y="62" width="28" height="2" rx="1" fill="#7f8c8d"/>
      <circle cx="32" cy="24" r="4.2" fill="#2c3e50"/>
      <g class="blades" id="blades">
        <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9"/>
        <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(120 32 24)"/>
        <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(240 32 24)"/>
      </g>
    </svg>

    <h1>üå¨Ô∏è Sterownik Wiatrowy</h1>

    <!-- Sensory -->
    <div class="card"><span class="label">Wiatrak (energia)</span> <span class="value"><span id="kwh">‚Äî</span><span class="unit">kWh</span></span></div>
    <div class="card"><span class="label">Moc ≈Çadowania</span> <span class="value"><span id="power">‚Äî</span><span class="unit">W</span></span></div>
    <div class="card"><span class="label">Na≈Çadowanie baterii</span> <span class="value"><span id="soc">‚Äî</span><span class="unit">%</span></span></div>
    <div class="card"><span class="label">Napiƒôcie baterii</span> <span class="value"><span id="bat_v">‚Äî</span><span class="unit">V</span></span></div>
    <div class="card"><span class="label">PrƒÖd ≈Çadowania</span> <span class="value"><span id="bat_a">‚Äî</span><span class="unit">A</span></span></div>

    <div class="card">
      <span class="label">Hamulec turbiny</span>
      <span class="value" id="brake">‚Äî</span><br><br>
      <button id="btnBrake">Prze≈ÇƒÖcz hamulec</button>
    </div>

    <!-- Wykres -->
    <div class="chart-card">
      <div class="chart-toolbar">
        <strong>üìä Wykres mocy (co 30 min)</strong>
        <span class="muted">‚Ä¢ wybierz dzie≈Ñ:</span>
        <input type="date" id="dayPicker">
      </div>
      <canvas id="powerChart" height="220"></canvas>
      <div class="muted" style="margin-top:6px;">Dane zapisywane lokalnie w przeglƒÖdarce. O≈õ czasu: 00:00‚Äì24:00 (HH:mm).</div>
    </div>

    <div id="qrcode"></div>
  </div>

<script>
  /* ====== HAS≈ÅO ====== */
  const PASSWORD = "tomek1425"; // zmie≈Ñ na swoje

  function getParam(name){
    const m = new RegExp('[?&]'+name+'=([^&]+)').exec(location.search);
    return m ? decodeURIComponent(m[1].replace(/\+/g,' ')) : null;
  }

  function unlockWith(value){
    const given = String(value || '').trim();
    const ok = (given === String(PASSWORD).trim());
    if (ok){
      document.getElementById("lock").style.display="none";
      document.getElementById("app").style.display="block";
      initApp();
    } else {
      document.getElementById("lockMsg").textContent="‚ùå Z≈Çe has≈Ço";
    }
    return ok;
  }

  document.getElementById("unlockBtn").onclick = ()=> unlockWith(document.getElementById("pwd").value);
  document.getElementById("pwd").onkeydown = e=>{ if(e.key==="Enter") unlockWith(document.getElementById("pwd").value); };

  // URL ?pass=1234
  const passParam = getParam('pass'); if (passParam) unlockWith(passParam);

  /* ====== APLIKACJA ====== */
  function initApp(){
    const PREFIX="sterownik_wiatrowy";
    const WS_URL="wss://broker.hivemq.com:8884/mqtt";

    function parseNumber(val){ const m=String(val).match(/-?\d+(?:[.,]\d+)?/); return m?parseFloat(m[0].replace(',','.')):NaN; }
    function fmt1dec(n){ if(isNaN(n)) return "‚Äî"; return (Math.round(n*10)/10).toFixed(1).replace(".",","); }

    const els={
      kwh:document.getElementById("kwh"),
      power:document.getElementById("power"),
      soc:document.getElementById("soc"),
      bat_v:document.getElementById("bat_v"),
      bat_a:document.getElementById("bat_a"),
      brake:document.getElementById("brake"),
      btn:document.getElementById("btnBrake")
    };

    let brakeState="OFF";
    const blades=document.getElementById("blades");

    function updateRotor(power){
      const p=Math.max(0,Math.min(3000,Number(power)||0));
      const dur=8-(p/3000)*(8-1.5);
      blades.style.setProperty("--dur",dur.toFixed(2)+"s");
      blades.style.setProperty("--play", brakeState==="ON" ? "paused" : "running");
    }

    // ====== POMOCNICZE: zakres dnia lokalnie (00:00‚Äì24:00) ======
    function startOfDayLocal(dayStr){
      const [y,m,d] = dayStr.split("-").map(Number);
      return new Date(y, m-1, d, 0, 0, 0, 0);
    }
    function endOfDayLocal(dayStr){
      const s = startOfDayLocal(dayStr);
      return new Date(s.getTime() + 24*60*60*1000);
    }
    function ymd(d){ return d.toISOString().slice(0,10); }

    // ====== MQTT ======
    const client=mqtt.connect(WS_URL,{clientId:"webdash_"+Math.random().toString(16).slice(2)});
    client.on("connect",()=>client.subscribe(`${PREFIX}/#`));

    client.on("message",(topic,payload)=>{
      const val=payload.toString();
      const parts=topic.split("/");
      const ix=parts.indexOf("sensor")>=0?parts.indexOf("sensor"):parts.indexOf("switch");
      const key=(ix>=0&&parts[ix+1])?parts[ix+1].toLowerCase():"";

      if(key.includes("wiatrak")&&key.includes("kwh")){ els.kwh.textContent=fmt1dec(parseNumber(val)); return; }
      if(key.startsWith("moc")){
        const p=parseNumber(val);
        els.power.textContent=fmt1dec(p);
        updateRotor(p);
        savePower(new Date(),p);
        refreshChart();
        return;
      }
      if(key.includes("procent")||key.includes("naladowania")){ els.soc.textContent=fmt1dec(parseNumber(val)); return; }
      if(key.startsWith("nap")){ els.bat_v.textContent=fmt1dec(parseNumber(val)); return; }
      if(key.startsWith("pr")){ els.bat_a.textContent=fmt1dec(parseNumber(val)); return; }
      if(key.includes("hamulec")){
        brakeState=String(val).trim().toUpperCase();
        els.brake.textContent=(brakeState==="ON")?"W≈ÇƒÖczony":"Wy≈ÇƒÖczony";
        els.btn.textContent=(brakeState==="ON")?"Wy≈ÇƒÖcz hamulec":"W≈ÇƒÖcz hamulec";
        els.btn.className=(brakeState==="ON")?"off":"";
        updateRotor(parseNumber(els.power.textContent.replace(",",".")));
      }
    });

    els.btn.onclick=()=>{ const next=(brakeState==="ON")?"OFF":"ON"; client.publish(`${PREFIX}/switch/hamulec_turbiny/command`,next); };

    // ====== QR ======
    new QRCode(document.getElementById("qrcode"),{text:"https://tomasz179.github.io/Wiatrak-sterownik/",width:200,height:200});

    // ====== Wykres (pe≈Çna doba 00:00‚Äì24:00, PL HH:mm) ======
    const ctx=document.getElementById("powerChart").getContext("2d");
    const chart=new Chart(ctx,{
      type:"line",
      data:{datasets:[{label:"Moc (W)",data:[],borderWidth:2,pointRadius:2,spanGaps:true,tension:0}]},
      options:{
        parsing:false, responsive:true,
        scales:{
          x:{
            type:"time",
            time:{ unit:"hour", stepSize:1, displayFormats:{hour:"HH:mm",minute:"HH:mm"}, tooltipFormat:"HH:mm" },
            ticks:{ callback:(v)=> new Intl.DateTimeFormat("pl-PL",{hour:"2-digit",minute:"2-digit",hour12:false}).format(new Date(v)) },
            title:{ display:true, text:"Czas" },
            // min/max ustawimy dynamicznie w refreshChartForDay()
          },
          y:{ beginAtZero:true, title:{ display:true, text:"Waty (W)" } }
        },
        plugins:{ legend:{display:false} },
        interaction:{ intersect:false, mode:"nearest" }
      }
    });

    // ====== ZAPIS/ODCZYT PR√ìBEK (wsteczna zgodno≈õƒá) ======
    // zapis: t jako ms od epoki
    function savePower(ts, p){
      const key = "pow" + ymd(ts);
      const arr = JSON.parse(localStorage.getItem(key) || "[]");
      arr.push({ t: ts.getTime(), p });
      localStorage.setItem(key, JSON.stringify(arr));
    }

    // odczyt: wspiera stare wpisy (ISO) i nowe (ms)
    function loadDay(day){
      const raw = JSON.parse(localStorage.getItem("pow"+day) || "[]");
      return raw.map(r => {
        const tms = (typeof r.t === "number") ? r.t : Date.parse(r.t);
        return { t: tms, p: r.p };
      });
    }

    // ====== Agregacja co 30 min w zakresie 00:00‚Äì24:00 ======
    function halfHourAvg(arr, day){
      const out = [];
      const base = startOfDayLocal(day);
      for (let i = 0; i < 48; i++){
        const start = new Date(base.getTime() + i * 30 * 60000);
        const end   = new Date(start.getTime() + 30 * 60000);
        const subset = arr.filter(r => {
          const t = new Date(r.t);
          return t >= start && t < end;
        });
        if (subset.length){
          const avg = subset.reduce((s, r) => s + r.p, 0) / subset.length;
          out.push({ x: start, y: avg });
        } else {
          out.push({ x: start, y: null });
        }
      }
      return out;
    }

    function refreshChartForDay(day){
      const data = halfHourAvg(loadDay(day), day);
      chart.data.datasets[0].data = data;

      // sta≈Çe granice osi X (00:00‚Äì24:00) dla wybranego dnia ‚Äî w czasie lokalnym
      chart.options.scales.x.min = startOfDayLocal(day);
      chart.options.scales.x.max = endOfDayLocal(day);

      chart.update();
    }

    function refreshChart(){
      const d = dayPicker.value || ymd(new Date());
      refreshChartForDay(d);
    }

    // ====== Kalendarz dnia ======
    const dayPicker=document.getElementById("dayPicker");
    dayPicker.value=ymd(new Date());
    dayPicker.onchange=()=>refreshChartForDay(dayPicker.value);

    // Inicjalne od≈õwie≈ºenie
    refreshChart();
  }
</script>
</body>
</html>
