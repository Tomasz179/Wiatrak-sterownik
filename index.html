<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sterownik Wiatrowy – Dashboard</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    :root{ --card-w:1100px; }

    body{
      font-family: Arial, sans-serif;
      padding:20px;
      color:#111;
      min-height:100vh;
      margin:0;
      background:#000;
    }

    .bg{
      position: fixed;
      inset: 0;
      z-index: -2;
      overflow: hidden;
      background: url("assets/wiatrak.webp") center top / cover no-repeat;
    }
    .bg-video{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center top;
    }

    .ui-overlay{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
      background: linear-gradient(
        to bottom,
        rgba(255,255,255,0.00) 0%,
        rgba(255,255,255,0.08) 35%,
        rgba(255,255,255,0.18) 100%
      );
    }

    #app{ position: relative; z-index: 1; }

    h1{
      text-align:center;
      margin:8px 0 14px;
      text-shadow:0 1px 0 rgba(255,255,255,0.6);
    }

    #status{
      max-width:var(--card-w);
      margin:0.5rem auto 1rem;
      font-size:12px;
      text-align:center;
      text-shadow:0 1px 0 rgba(255,255,255,0.6);
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
      gap:12px;
      max-width:var(--card-w);
      margin:0 auto;
    }

    .card{
      background: rgba(255,255,255,0.92);
      padding:15px;
      border-radius:14px;
      box-shadow:0 10px 22px rgba(0,0,0,0.14);
    }

    .label{ font-weight:bold; }
    .value{
      float:right;
      font-weight:700;
      min-width: 90px;
      text-align:right;
      display:inline-block;
    }
    .unit{ margin-left:4px; color:#666; font-weight:500 }

    .wind-card.good   { background: rgba(232,245,233,0.92); }
    .wind-card.mid    { background: rgba(255,249,196,0.92); }
    .wind-card.high   { background: rgba(255,224,178,0.92); }
    .wind-card.danger { background: rgba(255,205,210,0.92); }
  </style>
</head>

<body>

<div class="bg">
  <video class="bg-video" autoplay muted loop playsinline>
    <source src="assets/wiatrak.mp4" type="video/mp4">
  </video>
</div>
<div class="ui-overlay"></div>

<div id="app">
  <h1>Sterownik Wiatrowy</h1>

  <div id="status">
    MQTT: <b id="mqttStatus">—</b>
    <span id="diag"></span>
  </div>

  <div class="grid">

    <div class="card">
      <span class="label">Energia wiatraka</span>
      <span class="value"><span id="kwh">—</span><span class="unit">kWh</span></span>
    </div>

    <div class="card">
      <span class="label">Moc wiatraka</span>
      <span class="value"><span id="power">—</span><span class="unit">W</span></span>
    </div>

    <div class="card">
      <span class="label">Napięcie baterii</span>
      <span class="value"><span id="bat_v">—</span><span class="unit">V</span></span>
    </div>

    <div class="card">
      <span class="label">Prąd wiatraka</span>
      <span class="value"><span id="bat_a">—</span><span class="unit">A</span></span>
    </div>

    <div class="card">
      <span class="label">Napięcie wiatraka</span>
      <span class="value"><span id="wind_v">—</span><span class="unit">V</span></span>
    </div>

    <div class="card">
      <span class="label">Obroty turbiny</span>
      <span class="value"><span id="rpm">—</span><span class="unit">RPM</span></span>
    </div>

    <div class="card wind-card" id="windCard">
      <span class="label">Prędkość wiatru</span>
      <span class="value"><span id="wind">—</span><span class="unit">m/s</span></span>
    </div>

  </div>
</div>

<script>
(() => {
  const PREFIX = "sterownik_wiatrowy";
  const WS_URL = "wss://broker.hivemq.com:8884/mqtt";

  // public
  const TOPIC_WIND = `${PREFIX}/public/wind_speed`;

  // progi kolorowania karty prędkości wiatru
  const MID_AT=3, HIGH_AT=8, DANG_AT=15;

  const el = {
    kwh: document.getElementById('kwh'),
    power: document.getElementById('power'),
    bat_v: document.getElementById('bat_v'),
    bat_a: document.getElementById('bat_a'),
    wind_v: document.getElementById('wind_v'),
    rpm: document.getElementById('rpm'),
    wind: document.getElementById('wind'),
    windCard: document.getElementById('windCard'),
    mqttStatus: document.getElementById('mqttStatus'),
    diag: document.getElementById('diag'),
  };

  // Uwaga: u Ciebie już są podwójne podkreślenia zamiast polskich znaków,
  // więc dla spójności daję "napie__cie_wiatrak".
  // Jeśli topic masz inny – podmień tylko tutaj.
  const TOPICS = {
    kwh:    `${PREFIX}/sensor/wiatrak_kwh/state`,
    power:  `${PREFIX}/sensor/moc_wiatrak/state`,
    bat_v:  `${PREFIX}/sensor/napi__cie_baterii/state`,
    bat_a:  `${PREFIX}/sensor/pr__d_wiatrak/state`,
    wind_v: `${PREFIX}/sensor/napi__cie_wiatrak/state`,
    rpm:    `${PREFIX}/sensor/obroty_wiatraka/state`,
  };

  function num(v){
    const m=String(v).match(/-?\d+(?:[.,]\d+)?/);
    return m?parseFloat(m[0].replace(',','.')):NaN;
  }

  // Uniwersalny format 1 miejsce po przecinku (zgodnie z resztą UI)
  const fmt=n=>isNaN(n)?"—":n.toFixed(1).replace('.',',');

  // Jeśli chcesz RPM jako całkowite:
  // const fmtRpm=n=>isNaN(n)?"—":String(Math.round(n));

  function windColor(w){
    el.windCard.className="card wind-card";
    if(isNaN(w)) return;
    el.windCard.classList.add(
      w<DANG_AT ? w<HIGH_AT ? w<MID_AT?"good":"mid":"high" : "danger"
    );
  }

  let msg=0,last=0;
  const diag=()=>{
    el.diag.innerHTML=` | msg: <b>${msg}</b> | last: <b>${last?new Date(last).toLocaleTimeString():"—"}</b>`;
  };

  const client=mqtt.connect(WS_URL,{clientId:"web_"+Math.random().toString(16).slice(2)});

  client.on('connect',()=>{
    el.mqttStatus.textContent="połączono";
    [...Object.values(TOPICS),TOPIC_WIND].forEach(t=>client.subscribe(t));
  });

  client.on('message',(t,p)=>{
    msg++; last=Date.now(); diag();
    const v=num(p.toString());

    if(t===TOPIC_WIND){ el.wind.textContent=fmt(v); windColor(v); }

    if(t===TOPICS.kwh)    el.kwh.textContent=fmt(v);
    if(t===TOPICS.power)  el.power.textContent=fmt(v);
    if(t===TOPICS.bat_v)  el.bat_v.textContent=fmt(v);
    if(t===TOPICS.bat_a)  el.bat_a.textContent=fmt(v);
    if(t===TOPICS.wind_v) el.wind_v.textContent=fmt(v);
    if(t===TOPICS.rpm)    el.rpm.textContent=fmt(v); // lub fmtRpm(v)
  });

  client.on('offline',()=>el.mqttStatus.textContent="offline");
  client.on('error',()=>el.mqttStatus.textContent="błąd");
})();
</script>

</body>
</html>
