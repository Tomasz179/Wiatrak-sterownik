<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sterownik Wiatrowy ‚Äì MQTT (bez hase≈Ç i przycisk√≥w)</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{ --card-w:1100px; }
    body { font-family: Arial, sans-serif; background:#f6f7fb; padding:20px; color:#111; }

    h1 { text-align:center; margin:8px 0 14px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:12px; max-width:var(--card-w); margin:0 auto; }
    .card { background:white; padding:15px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.07); }
    .label { font-weight:bold; }
    .value { float:right; font-weight:700; }
    .unit { margin-left:4px; color:#666; font-weight:500 }

    /* Wiatrak */
    .wind-wrap{max-width:var(--card-w); margin:0 auto;}
    .wind-svg { display:block; margin:0 auto 6px; width:240px; height:auto; }
    .blades { transform-origin: 32px 24px; animation: spin var(--dur, 4s) linear infinite; animation-play-state: var(--play, running); }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }

    /* Pasek statusu */
    #status { max-width:var(--card-w); margin:0.5rem auto; font-size:12px; color:#333; }
    #status b { font-weight:700; }

    /* QR */
    #qrcode { margin:18px auto; width:fit-content; }
  </style>
</head>
<body>
  <!-- APLIKACJA (bez blokady has≈Çem i trybu napiƒôcia) -->
  <div id="app">
    <div class="wind-wrap">
      <svg class="wind-svg" viewBox="0 0 64 64">
        <path d="M32 28 L28 62 L36 62 Z" fill="#2c3e50"/>
        <rect x="18" y="62" width="28" height="2" rx="1" fill="#7f8c8d"/>
        <circle cx="32" cy="24" r="4.2" fill="#2c3e50"/>
        <g class="blades" id="blades">
          <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9"/>
          <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(120 32 24)"/>
          <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(240 32 24)"/>
        </g>
      </svg>
    </div>

    <h1>üå¨Ô∏è Sterownik Wiatrowy</h1>
    <div id="status">Status MQTT: <b id="mqttStatus">inicjalizacja‚Ä¶</b></div>

    <div class="grid">
      <!-- Sensory -->
      <div class="card"><span class="label">Wiatrak (energia)</span> <span class="value"><span id="kwh">‚Äî</span><span class="unit">kWh</span></span></div>
      <div class="card"><span class="label">Moc ≈Çadowania</span> <span class="value"><span id="power">‚Äî</span><span class="unit">W</span></span></div>
      <div class="card"><span class="label">Na≈Çadowanie baterii</span> <span class="value"><span id="soc">‚Äî</span><span class="unit">%</span></span></div>
      <div class="card"><span class="label">Napiƒôcie baterii</span> <span class="value"><span id="bat_v">‚Äî</span><span class="unit">V</span></span></div>
      <div class="card"><span class="label">PrƒÖd ≈Çadowania</span> <span class="value"><span id="bat_a">‚Äî</span><span class="unit">A</span></span></div>
      <div class="card"><span class="label">Prƒôdko≈õƒá wiatru</span> <span class="value"><span id="wind">‚Äî</span><span class="unit">m/s</span></span></div>

      <!-- Hamulec (tylko podglƒÖd) -->
      <div class="card">
        <span class="label">Hamulec turbiny</span>
        <span class="value" id="brake">‚Äî</span>
      </div>

      <!-- Wyj≈õcie LOAD (tylko podglƒÖd) -->
      <div class="card">
        <span class="label">Wyj≈õcie LOAD</span>
        <span class="value" id="loadState">‚Äî</span>
      </div>

      <!-- Usuniƒôto: Tryb napiƒôcia, Typ baterii, Battery Full Voltage, przyciski -->
    </div>

    <div id="qrcode"></div>
  </div>

<script>
function initApp(){
  const PREFIX = "sterownik_wiatrowy";
  const WS_URL = "wss://broker.hivemq.com:8884/mqtt";

  function parseNumber(val){ const m=String(val).match(/-?\d+(?:[.,]\d+)?/); return m?parseFloat(m[0].replace(',', '.')):NaN; }
  function fmt1dec(n){ if(isNaN(n)) return "‚Äî"; return (Math.round(n*10)/10).toFixed(1).replace('.',','); }

  const els={
    kwh:document.getElementById('kwh'),
    power:document.getElementById('power'),
    soc:document.getElementById('soc'),
    bat_v:document.getElementById('bat_v'),
    bat_a:document.getElementById('bat_a'),
    wind:document.getElementById('wind'),
    brake:document.getElementById('brake'),
    loadState:document.getElementById('loadState'),
    mqttStatus:document.getElementById('mqttStatus'),
  };

  const blades=document.getElementById('blades');
  let brakeState='OFF';
  let lastWind=null, lastPower=null;

  function recomputeRotor(){
    let dur;
    if(lastWind!=null && !isNaN(lastWind)){
      const w=Math.max(0, Math.min(25, lastWind)); // [0..25] m/s
      const rpm = 10 + w*8; // prosta mapowanie: 10 rpm przy ciszy + 8 rpm na ka≈ºdy 1 m/s
      dur = Math.max(0.6, 60/ rpm); // sekundy/obr√≥t
    } else {
      const p=Math.max(0,Math.min(3000,Number(lastPower)||0));
      dur=8-(p/3000)*(8-1.5);
    }
    blades.style.setProperty('--dur',dur.toFixed(2)+'s');
    blades.style.setProperty('--play', brakeState==='ON' ? 'paused' : 'running');
  }

  const TOPICS = {
    kwh:   [`${PREFIX}/sensor/wiatrak_kwh/state`],
    power: [`${PREFIX}/sensor/moc__adowania/state`, `${PREFIX}/sensor/moc___adowania/state`],
    soc:   [`${PREFIX}/sensor/procent_na__adowania_baterii/state`, `${PREFIX}/sensor/procent_na_adowania_baterii/state`],
    bat_v: [`${PREFIX}/sensor/napi_cie_baterii/state`, `${PREFIX}/sensor/napi__cie_baterii/state`],
    bat_a: [`${PREFIX}/sensor/pr_d__adowania/state`, `${PREFIX}/sensor/pr__d___adowania/state`],
    wind:  [`${PREFIX}/sensor/predkosc_wiatru/state`],
    brake_state: [`${PREFIX}/switch/hamulec_turbiny/state`],
    load_state:  [`${PREFIX}/switch/wyjscie_load/state`, `${PREFIX}/switch/wyj__cie_load/state`],
  };
  const matchTopic = (incoming, candidates) => (Array.isArray(candidates)?candidates:[candidates]).includes(incoming);

  const client=mqtt.connect(WS_URL,{clientId:'webdash_'+Math.random().toString(16).slice(2)});
  client.on('connect',()=>{
    els.mqttStatus.textContent='po≈ÇƒÖczono';
    Object.values(TOPICS).flat().forEach(tp=>{
      const arr = Array.isArray(tp) ? tp : [tp];
      arr.forEach(t => { if (t.endsWith('/state')) client.subscribe(t); });
    });
  });
  client.on('reconnect',()=>{ els.mqttStatus.textContent='ponowne ≈ÇƒÖczenie‚Ä¶'; });
  client.on('close',()=>{ els.mqttStatus.textContent='roz≈ÇƒÖczono'; });
  client.on('error',(e)=>{ els.mqttStatus.textContent='b≈ÇƒÖd MQTT (konsola)'; console.error('MQTT error:', e); });

  client.on('message',(topic,payload)=>{
    const val = payload.toString();
    const n = (x)=>{ const m=String(x).match(/-?\d+(?:[.,]\d+)?/); return m?parseFloat(m[0].replace(',','.')):NaN; };

    if (matchTopic(topic, TOPICS.kwh))   { const v=n(val); els.kwh.textContent  = isNaN(v)?val:fmt1dec(v); return; }
    if (matchTopic(topic, TOPICS.power)) { const v=n(val); els.power.textContent= isNaN(v)?val:fmt1dec(v); lastPower=v; recomputeRotor(); return; }
    if (matchTopic(topic, TOPICS.soc))   { const v=n(val); els.soc.textContent  = isNaN(v)?val:fmt1dec(v); return; }
    if (matchTopic(topic, TOPICS.bat_v)) { const v=n(val); els.bat_v.textContent= isNaN(v)?val:fmt1dec(v); return; }
    if (matchTopic(topic, TOPICS.bat_a)) { const v=n(val); els.bat_a.textContent= isNaN(v)?val:fmt1dec(v); return; }
    if (matchTopic(topic, TOPICS.wind))  { const v=n(val); els.wind.textContent = isNaN(v)?val:fmt1dec(v); lastWind=v; recomputeRotor(); return; }

    if (matchTopic(topic, TOPICS.brake_state)){
      const s=String(val).trim().toUpperCase();
      brakeState=s; els.brake.textContent=(s==='ON')?'W≈ÇƒÖczony':'Wy≈ÇƒÖczony';
      recomputeRotor();
      return;
    }
    if (matchTopic(topic, TOPICS.load_state)){
      const s=String(val).trim().toUpperCase();
      els.loadState.textContent=(s==='ON')?'W≈ÇƒÖczone':'Wy≈ÇƒÖczone';
      return;
    }
  });

  new QRCode(document.getElementById('qrcode'),{text:'https://tomasz179.github.io/Wiatrak-sterownik/',width:200,height:200});
}

document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
