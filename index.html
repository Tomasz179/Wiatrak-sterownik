<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sterownik Wiatrowy – MQTT</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    h1 { text-align:center; margin-top:10px; }
    .card { background:white; padding:15px; margin:10px auto; border-radius:10px; max-width:420px;
            box-shadow:0 2px 5px rgba(0,0,0,0.2); }
    .label { font-weight:bold; }
    .value { float:right; font-weight:700; }
    button { padding:10px 16px; margin-top:10px; border:none; border-radius:6px;
             background:#0d6efd; color:white; font-size:15px; cursor:pointer; }
    button.off { background:#dc3545; }
    .unit { margin-left:4px; color:#666; font-weight:500 }
    #qrcode { margin:30px auto; width:fit-content; }

    /* --- WIATRAK SVG --- */
    .wind-svg { display:block; margin:0 auto 6px; width:240px; height:auto; }
    .blades {
      transform-origin: 32px 24px;        /* środek piasty */
      animation: spin 4s linear infinite; /* płynny obrót łopat */
    }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
  </style>
</head>
<body>

  <!-- WIATRAK (SVG, piasta nieruchoma, łopaty zakotwiczone w piaście) -->
  <svg class="wind-svg" viewBox="0 0 64 64" aria-hidden="true">
    <!-- wieża -->
    <path d="M32 28 L28 62 L36 62 Z" fill="#2c3e50"/>
    <!-- podłoże -->
    <rect x="18" y="62" width="28" height="2" rx="1" fill="#7f8c8d"/>
    <!-- piasta (NIE rusza się) -->
    <circle cx="32" cy="24" r="4.2" fill="#2c3e50"/>
    <!-- łopaty (TYLKO ta grupa się obraca wokół piasty) -->
    <g class="blades">
      <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9"/>
      <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(120 32 24)"/>
      <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(240 32 24)"/>
    </g>
  </svg>

  <h1>Sterownik Wiatrowy</h1>

  <!-- Karty z wartościami -->
  <div class="card"><span class="label">Wiatrak (energia)</span> <span class="value"><span id="kwh">—</span><span class="unit">kWh</span></span></div>
  <div class="card"><span class="label">Moc ładowania</span> <span class="value"><span id="power">—</span><span class="unit">W</span></span></div>
  <div class="card"><span class="label">Naładowanie baterii</span> <span class="value"><span id="soc">—</span><span class="unit">%</span></span></div>
  <div class="card"><span class="label">Napięcie baterii</span> <span class="value"><span id="bat_v">—</span><span class="unit">V</span></span></div>
  <div class="card"><span class="label">Prąd ładowania</span> <span class="value"><span id="bat_a">—</span><span class="unit">A</span></span></div>

  <div class="card">
    <span class="label">Hamulec turbiny</span>
    <span class="value" id="brake">—</span><br><br>
    <button id="btnBrake">Przełącz hamulec</button>
  </div>

  <!-- Kod QR do strony GitHub Pages -->
  <div id="qrcode"></div>

  <script>
    // ---- USTAWIENIA MQTT ----
    const PREFIX = "sterownik_wiatrowy";
    const WS_URL = "wss://broker.hivemq.com:8884/mqtt";

    // ---- FORMATOWANIE ----
    // 1 miejsce po przecinku + przecinek zamiast kropki
    function fmt1dec(n) {
      const x = parseFloat(String(n).replace(',', '.'));
      if (isNaN(x)) return n; // jak przyjdzie tekst, nic nie ruszamy
      return x.toFixed(1).replace('.', ',');
    }

    // ---- POŁĄCZENIE MQTT ----
    const client = mqtt.connect(WS_URL, { clientId: "webdash_" + Math.random().toString(16).slice(2) });

    const els = {
      kwh:  document.getElementById("kwh"),
      power:document.getElementById("power"),
      soc:  document.getElementById("soc"),
      bat_v:document.getElementById("bat_v"),
      bat_a:document.getElementById("bat_a"),
      brake:document.getElementById("brake"),
      btn:  document.getElementById("btnBrake"),
    };
    let brakeState = "OFF";

    client.on("connect", () => {
      client.subscribe(`${PREFIX}/#`);
    });

    client.on("message", (topic, payload) => {
      const valRaw = payload.toString();
      const parts = topic.split("/");
      const ix = parts.indexOf("sensor") >= 0 ? parts.indexOf("sensor") : parts.indexOf("switch");
      const key = (ix >= 0 && parts[ix+1]) ? parts[ix+1].toLowerCase() : "";

      // kWh
      if (key.includes("wiatrak") && key.includes("kwh")) { 
        els.kwh.textContent = fmt1dec(valRaw); 
        return; 
      }
      // Moc (W)
      if (key.startsWith("moc")) { 
        els.power.textContent = fmt1dec(valRaw); 
        return; 
      }
      // SOC (%)
      if (key.includes("procent") || key.includes("naladowania")) { 
        els.soc.textContent = fmt1dec(valRaw); 
        return; 
      }
      // Napięcie baterii (V)
      if (key.startsWith("nap")) { 
        els.bat_v.textContent = fmt1dec(valRaw); 
        return; 
      }
      // Prąd ładowania (A)
      if (key.startsWith("pr")) { 
        els.bat_a.textContent = fmt1dec(valRaw); 
        return; 
      }

      // Hamulec
      if (key.includes("hamulec")) {
        brakeState = valRaw;
        els.brake.textContent = (valRaw === "ON") ? "Włączony" : "Wyłączony";
        els.btn.textContent = (valRaw === "ON") ? "Wyłącz hamulec" : "Włącz hamulec";
        els.btn.className = (valRaw === "ON") ? "off" : "";
      }
    });

    els.btn.addEventListener("click", () => {
      const next = (brakeState === "ON") ? "OFF" : "ON";
      client.publish(`${PREFIX}/switch/hamulec_turbiny/command`, next);
    });

    // ---- QR (stały adres GitHub Pages) ----
    new QRCode(document.getElementById("qrcode"), {
      text: "https://tomasz179.github.io/Wiatrak-sterownik/",
      width: 200,
      height: 200
    });
  </script>
</body>
</html>
