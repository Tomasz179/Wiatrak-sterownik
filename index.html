<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sterownik Wiatrowy – MQTT (public wind_speed)</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{ --card-w:1100px; }
    body { font-family: Arial, sans-serif; background:#f6f7fb; padding:20px; color:#111; }

    h1 { text-align:center; margin:8px 0 14px; }
    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
      gap:12px;
      max-width:var(--card-w);
      margin:0 auto;
    }
    .card {
      background:white;
      padding:15px;
      border-radius:12px;
      box-shadow:0 3px 10px rgba(0,0,0,0.07);
    }
    .label { font-weight:bold; }
    .value { float:right; font-weight:700; }
    .unit { margin-left:4px; color:#666; font-weight:500 }

    /* Wiatrak */
    .wind-wrap{max-width:var(--card-w); margin:0 auto;}
    .wind-svg { display:block; margin:0 auto 6px; width:240px; height:auto; }
    .blades {
      transform-origin: 32px 24px;
      animation: spin var(--dur, 4s) linear infinite;
      animation-play-state: var(--play, running);
    }
    @keyframes spin {
      from { transform: rotate(0deg);}
      to   { transform: rotate(360deg);}
    }

    /* Pasek statusu */
    #status { max-width:var(--card-w); margin:0.5rem auto; font-size:12px; color:#333; }
    #status b { font-weight:700; }

    /* QR */
    #qrcode { margin:18px auto; width:fit-content; }
    .small { font-size:12px; color:#666; margin-top:8px; }
    code { background:#f0f0f0; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div id="app">
    <div class="wind-wrap">
      <svg class="wind-svg" viewBox="0 0 64 64">
        <path d="M32 28 L28 62 L36 62 Z" fill="#2c3e50"/>
        <rect x="18" y="62" width="28" height="2" rx="1" fill="#7f8c8d"/>
        <circle cx="32" cy="24" r="4.2" fill="#2c3e50"/>
        <g class="blades" id="blades">
          <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9"/>
          <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(120 32 24)"/>
          <polygon points="32,24 30,24 27,-8 37,-8 34,24" fill="#2980b9" transform="rotate(240 32 24)"/>
        </g>
      </svg>
    </div>

    <h1>Sterownik Wiatrowy M6</h1>
    <div id="status">Status MQTT: <b id="mqttStatus">inicjalizacja…</b></div>

    <div class="grid">
      <div class="card">
        <span class="label">Wiatrak (energia)</span>
        <span class="value"><span id="kwh">—</span><span class="unit">kWh</span></span>
      </div>
      <div class="card">
        <span class="label">Moc ładowania</span>
        <span class="value"><span id="power">—</span><span class="unit">W</span></span>
      </div>
      <div class="card">
        <span class="label">Naładowanie baterii</span>
        <span class="value"><span id="soc">—</span><span class="unit">%</span></span>
      </div>
      <div class="card">
        <span class="label">Napięcie baterii</span>
        <span class="value"><span id="bat_v">—</span><span class="unit">V</span></span>
      </div>
      <div class="card">
        <span class="label">Prąd ładowania</span>
        <span class="value"><span id="bat_a">—</span><span class="unit">A</span></span>
      </div>

      <div class="card">
        <span class="label">Prędkość wiatru (public)</span>
        <span class="value"><span id="wind">—</span><span class="unit">m/s</span></span>
        <div class="small">Topic: <code>sterownik_wiatrowy/public/wind_speed</code></div>
      </div>

      <div class="card">
        <span class="label">Hamulec turbiny</span>
        <span class="value" id="brake">—</span>
      </div>

      <div class="card">
        <span class="label">Wyjście LOAD</span>
        <span class="value" id="loadState">—</span>
      </div>
    </div>

    <div id="qrcode"></div>
  </div>

<script>
function initApp(){
  const PREFIX = "sterownik_wiatrowy";
  const WS_URL = "wss://broker.hivemq.com:8884/mqtt";
  const TOPIC_WIND_PUBLIC = `${PREFIX}/public/wind_speed`;

  function parseNumber(val){
    const m = String(val).match(/-?\d+(?:[.,]\d+)?/);
    return m ? parseFloat(m[0].replace(',', '.')) : NaN;
  }
  function fmt1dec(n){
    if(isNaN(n)) return "—";
    return (Math.round(n*10)/10).toFixed(1).replace('.',',');
  }

  const els = {
    kwh:  document.getElementById('kwh'),
    power:document.getElementById('power'),
    soc:  document.getElementById('soc'),
    bat_v:document.getElementById('bat_v'),
    bat_a:document.getElementById('bat_a'),
    wind: document.getElementById('wind'),
    brake:document.getElementById('brake'),
    loadState:document.getElementById('loadState'),
    mqttStatus:document.getElementById('mqttStatus'),
  };

  const blades = document.getElementById('blades');
  let brakeState = 'OFF';
  let lastWind = null;
  let lastPower = null;

  function recomputeRotor(){
    let dur;
    if(lastWind != null && !isNaN(lastWind)){
      const w = Math.max(0, Math.min(25, lastWind)); // [0..25] m/s
      const rpm = 10 + w*8;
      dur = Math.max(0.6, 60 / rpm);
    } else {
      const p = Math.max(0, Math.min(3000, Number(lastPower)||0));
      dur = 8 - (p/3000)*(8-1.5);
    }
    blades.style.setProperty('--dur', dur.toFixed(2) + 's');
    blades.style.setProperty('--play', brakeState === 'ON' ? 'paused' : 'running');
  }

  // Twoje dotychczasowe topic-y (jak w Twoim pliku)
  const TOPICS = {
    kwh:   [`${PREFIX}/sensor/wiatrak_kwh/state`],
    power: [`${PREFIX}/sensor/moc__adowania/state`, `${PREFIX}/sensor/moc___adowania/state`],
    soc:   [`${PREFIX}/sensor/procent_na__adowania_baterii/state`, `${PREFIX}/sensor/procent_na_adowania_baterii/state`],
    bat_v: [`${PREFIX}/sensor/napi_cie_baterii/state`, `${PREFIX}/sensor/napi__cie_baterii/state`],
    bat_a: [`${PREFIX}/sensor/pr_d__adowania/state`, `${PREFIX}/sensor/pr__d___adowania/state`],
    brake_state: [`${PREFIX}/switch/hamulec_turbiny/state`],
    load_state:  [`${PREFIX}/switch/wyjscie_load/state`, `${PREFIX}/switch/wyj__cie_load/state`],
  };

  const matchTopic = (incoming, candidates) =>
    (Array.isArray(candidates)?candidates:[candidates]).includes(incoming);

  const client = mqtt.connect(WS_URL, {
    clientId: 'webdash_'+Math.random().toString(16).slice(2),
    clean: true,
    connectTimeout: 8000,
    reconnectPeriod: 2000,
  });

  client.on('connect', ()=>{
    els.mqttStatus.textContent = 'połączono';

    // Subskrypcje tylko tego, co potrzebujesz (bez #)
    Object.values(TOPICS).flat().forEach(t=>{
      client.subscribe(t, {qos:0});
    });

    // Najważniejsze: publiczny wiatr
    client.subscribe(TOPIC_WIND_PUBLIC, {qos:0});
    console.log("SUB:", TOPIC_WIND_PUBLIC);
  });

  client.on('reconnect', ()=>{ els.mqttStatus.textContent='ponowne łączenie…'; });
  client.on('close', ()=>{ els.mqttStatus.textContent='rozłączono'; });
  client.on('error',(e)=>{ els.mqttStatus.textContent='błąd MQTT (konsola)'; console.error('MQTT error:', e); });

  client.on('message',(topic,payload)=>{
    const val = payload.toString();
    console.log('MQTT:', topic, '=>', val);

    const n = (x)=>parseNumber(x);

    // ======= PUBLIC WIND (KLUCZ) =======
    if (topic === TOPIC_WIND_PUBLIC) {
      const v = n(val);
      if (isNaN(v)) {
        lastWind = null;
        els.wind.textContent = "—";
      } else {
        lastWind = v;
        els.wind.textContent = fmt1dec(v);
      }
      recomputeRotor();
      return;
    }
    // ====================================

    if (matchTopic(topic, TOPICS.kwh))   {
      const v = n(val);
      els.kwh.textContent  = isNaN(v) ? val : fmt1dec(v);
      return;
    }
    if (matchTopic(topic, TOPICS.power)) {
      const v = n(val);
      els.power.textContent = isNaN(v) ? val : fmt1dec(v);
      lastPower = v;
      recomputeRotor();
      return;
    }
    if (matchTopic(topic, TOPICS.soc))   {
      const v = n(val);
      els.soc.textContent  = isNaN(v) ? val : fmt1dec(v);
      return;
    }
    if (matchTopic(topic, TOPICS.bat_v)) {
      const v = n(val);
      els.bat_v.textContent= isNaN(v) ? val : fmt1dec(v);
      return;
    }
    if (matchTopic(topic, TOPICS.bat_a)) {
      const v = n(val);
      els.bat_a.textContent= isNaN(v) ? val : fmt1dec(v);
      return;
    }

    if (matchTopic(topic, TOPICS.brake_state)){
      const s = String(val).trim().toUpperCase();
      brakeState = s;
      els.brake.textContent = (s==='ON') ? 'Włączony' : 'Wyłączony';
      recomputeRotor();
      return;
    }
    if (matchTopic(topic, TOPICS.load_state)){
      const s = String(val).trim().toUpperCase();
      els.loadState.textContent = (s==='ON') ? 'Włączone' : 'Wyłączone';
      return;
    }
  });

  new QRCode(document.getElementById('qrcode'), {
    text: window.location.href,
    width:200,
    height:200
  });
}

document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
